@{
    ViewData["Title"] = "Movimiento de Stock";
    var idMov = ViewBag.IdMovimiento ?? 0;
}

@section Estilos {
    <!-- DataTables -->
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css" />
    <link rel="stylesheet" href="https://cdn.datatables.net/fixedheader/3.2.2/css/fixedHeader.dataTables.min.css" />

    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" />

    <!-- Select2 -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/select2@4.0.13/dist/css/select2.min.css" />

    <!-- Estilos generales -->
    <link rel="stylesheet" href="~/css/usuarios.css" />
    <link rel="stylesheet" href="~/css/redisenopantallas.css" />

    <!-- Estilos específicos de Stock -->
    <link rel="stylesheet" href="~/css/Stock.css?v=2.0" />
}

<div class="container page-99" style="margin-top:100px">

    <!-- HEADER -->
    <div class="cc-header shadow-lg rounded-4 p-4 mb-4 stock-header">
        <div class="d-flex align-items-center gap-3 flex-wrap">
            <div class="d-flex align-items-center gap-3">
                <span class="cc-badge stock-badge">
                    <i class="fa fa-exchange"></i>
                </span>
                <div>
                    <h2 class="m-0 fw-800" id="tituloMovimiento">Nuevo movimiento</h2>
                    <small class="text-muted-cc">
                        Alta / modificación de movimientos de stock de productos e insumos
                    </small>
                </div>
            </div>

            <div class="ms-auto d-flex gap-3 flex-wrap">
                <div class="cc-stat">
                    <div class="label">Ítems</div>
                    <div class="value" id="kpiCantItems">0</div>
                </div>
                <div class="cc-stat d-none d-md-block">
                    <div class="label">Total movimiento</div>
                    <div class="value" id="kpiTotalMovimiento">$ 0,00</div>
                </div>
            </div>
        </div>
    </div>

    <!-- FORM CABECERA -->
    <div class="card-glass p-4 mb-4 stock-card">
        <input type="hidden" id="IdMovimiento" value="@idMov" />

        <div class="row g-4 align-items-end">
            <div class="col-12 col-md-4">
                <label for="IdTipoMovimiento" class="form-label stock-label">Tipo movimiento</label>
                <select id="IdTipoMovimiento" class="form-select">
                    <option value="">Seleccione...</option>
                </select>
            </div>

            <div class="col-12 col-md-8">
                <label for="Comentario" class="form-label stock-label">Comentario</label>
                <input type="text"
                       id="Comentario"
                       class="form-control input-nuevop"
                       placeholder="Ej: Ajuste, ingreso de producción, corrección de stock, etc." />
            </div>
        </div>
    </div>

    <!-- DETALLE -->
    <div class="card-glass p-4 mb-4 stock-card">
        <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
            <div class="d-flex align-items-center gap-2">
                <i class="fa fa-list-ul text-light"></i>
                <h4 class="m-0 fw-800">Detalle del movimiento</h4>
            </div>

            <button class="btn btn-success px-3 stock-btn-add" onclick="abrirModalItems()">
                <i class="fa fa-plus-circle me-2"></i> Añadir ítems
            </button>
        </div>

        <div class="dt-dark-wrap">
            <table id="grd_Detalle" class="display nowrap compact dt-dark stock-grid" style="width:100%">
                <thead>
                    <tr>
                        <th style="width:14%">Tipo</th>
                        <th>Item</th>
                        <th style="width:12%">Cantidad</th>
                        <th style="width:14%">Costo</th>
                        <th style="width:14%">Subtotal</th>
                        <th style="width:8%"></th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>

    <!-- BOTONES FOOTER -->
    <div class="text-end mb-5">
        <button class="btn btn-secondary px-4 me-2" onclick="volver()">
            <i class="fa fa-arrow-left me-2"></i> Volver
        </button>
        <button class="btn btn-primary px-4" id="btnGuardarMovimiento" onclick="guardarMovimiento()">
            <i class="fa fa-save me-2"></i> Registrar
        </button>
    </div>
</div>

<!-- MODAL AÑADIR ITEMS -->
<div class="modal fade" id="modalItems" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered">
        <div class="modal-content stock-modal">
            <div class="modal-header stock-modal-header">
                <div class="d-flex align-items-center gap-2">
                    <span class="stock-modal-icon"><i class="fa fa-cubes"></i></span>
                    <div>
                        <h5 class="modal-title fw-800 mb-0">Añadir ítems</h5>
                        <small class="text-muted-cc">
                            La cantidad inicia en 1. El costo se toma del producto / insumo y no se edita.
                        </small>
                    </div>
                </div>
                <button type="button" class="btn-close stock-btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
            </div>

            <div class="modal-body stock-modal-body">
                <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
                    <button class="btn btn-outline-light btn-sm stock-btn-outline" type="button" onclick="agregarFilaModal()">
                        <i class="fa fa-plus"></i> Añadir fila
                    </button>
                </div>

                <div class="stock-modal-table-wrapper">
                    <table class="table table-borderless align-middle stock-modal-table">
                        <thead>
                            <tr>
                                <th style="width:14%">Tipo</th>
                                <th>Item</th>
                                <th style="width:12%">Cantidad</th>
                                <th style="width:14%">Costo</th>
                                <th style="width:14%">Subtotal</th>
                                <th style="width:7%"></th>
                            </tr>
                        </thead>
                        <tbody id="tbodyModalItems">
                            <!-- filas dinámicas -->
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="modal-footer stock-modal-footer">
                <button type="button" class="btn btn-outline-secondary px-4" data-bs-dismiss="modal">
                    Cancelar
                </button>
                <button type="button" class="btn btn-success px-4" onclick="confirmarItemsModal()">
                    <i class="fa fa-check-circle me-2"></i> Añadir al movimiento
                </button>
            </div>
        </div>
    </div>
</div>

<!-- MODAL EDITAR CANTIDAD -->
<div class="modal fade" id="modalEditarCantidad" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-md modal-dialog-centered">
        <div class="modal-content stock-modal">
            <div class="modal-header stock-modal-header">
                <div class="d-flex align-items-center gap-2">
                    <span class="stock-modal-icon"><i class="fa fa-pencil"></i></span>
                    <div>
                        <h5 class="modal-title fw-800 mb-0">Editar cantidad</h5>
                        <small class="text-muted-cc">Solo se modifica la cantidad, el costo se mantiene.</small>
                    </div>
                </div>
                <button type="button" class="btn-close stock-btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
            </div>

            <div class="modal-body stock-modal-body">
                <input type="hidden" id="editTempId" />

                <div class="mb-3">
                    <label class="form-label stock-label">Item</label>
                    <div class="stock-edit-item-name" id="editItemName">-</div>
                </div>

                <div class="row g-3">
                    <div class="col-6">
                        <label class="form-label stock-label">Cantidad</label>
                        <input type="text"
                               id="editCantidad"
                               class="form-control text-center"
                               placeholder="Ej: 2,5 o 2.5" />
                    </div>
                    <div class="col-6">
                        <label class="form-label stock-label">Costo unitario</label>
                        <div class="stock-edit-label" id="editCosto">$ 0,00</div>
                    </div>
                </div>

                <div class="mt-3">
                    <label class="form-label stock-label">Subtotal</label>
                    <div class="stock-edit-label" id="editSubtotal">$ 0,00</div>
                </div>
            </div>

            <div class="modal-footer stock-modal-footer">
                <button type="button" class="btn btn-outline-secondary px-4" data-bs-dismiss="modal">
                    Cancelar
                </button>
                <button type="button" class="btn btn-primary px-4" onclick="guardarCantidadEditada()">
                    <i class="fa fa-save me-2"></i> Guardar cambios
                </button>
            </div>
        </div>
    </div>
</div>

<partial name="~/Views/Utils/Modals.cshtml" />

@section Scripts {
    <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>

    <!-- DataTables -->
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/fixedheader/3.2.2/js/dataTables.fixedHeader.min.js"></script>

    <!-- Bootstrap (modals) -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Select2 -->
    <script src="https://cdn.jsdelivr.net/npm/select2@4.0.13/dist/js/select2.min.js"></script>

    <!-- Utilidades generales -->
    <script src="~/js/site.js"></script>

    <!-- Lógica de Stock -->
    <script src="~/js/StockNuevoModif.js?v=3.0"></script>
}
